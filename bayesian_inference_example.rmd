---
title: "Short Example of Implementing Bayesian Inference in Stan"
output: rmarkdown::github_document
header-includes: 
  \usepackage{float}
  \usepackage{mathtools}
---

## Set-up

```{r, echo=TRUE, results='hide', message=FALSE, warning=FALSE}
#setwd("https://github.com/davidrmoxley/inference") # set working directory
library(rstan)
```


## Generate data
Set sample to 100 individuals with heights normally distributed with a mean of 66 inches and standard deviation of 6 inches.

```{r, echo=TRUE, fig.align="center"}
N <- 100
Y <- rnorm(N, 66, 6)
```

Histogram shows they're normally distributed.
```{r, echo=FALSE, fig.align="center"}
hist(Y)
```

## Create a model in Stan

Stan models are comprised of at least three parts:

(1) data block

(2) parameter block

(3) model block


They can be written within separate file 

```{r, echo=TRUE}
m_stan <- 'data{
  int N;
  real Y[N]; // continuous variable Y for N individuals, ie array of heights
}
parameters{
  real mu; // continous unconstrained variable
  real<lower=0> sigma; // nonegative value
}
model{
  
  // likelihood
  for(i in 1:N)
    Y[i] ~ normal(mu,sigma); // individual i height, Yi is distributed normal with mean mu and sd sigma
  
  // priors
  mu ~ normal(68, 8);
  sigma ~ cauchy(0,1); // location parameter 0, scale parameter 1; effectively half cauchy bc sigma is nonegative
}'
```

## Fitting the model

Introducing parallelism will improve performance. Each chain can only be run on one core.

```{r, echo=TRUE}
cores <- parallel::detectCores() # determine the number of cores
cores
options(mc.cores = cores-2) # set parallel
```

Here, we have 8 cores available and decided to use 6. We'll run 6 chains, one per core.

>Note: we could run multiple chains per core. It is advisable to run at least 4 chains to increases chances of convergence.


In executing the model, you define the model codes, and map the data variables in your R environment to those defined in the Stan code.

```{r, echo=TRUE}
m_fit <- rstan::stan(model_code = m_stan, data = list(N=N, Y=Y), iter=500, chains=(cores-2))
```


## Interpreting

```{r, echo=TRUE, fig.align="center"}
print(m_fit)
```